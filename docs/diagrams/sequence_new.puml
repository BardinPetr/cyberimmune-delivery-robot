@startuml
!pragma teoz true
'autonumber

actor "Warehouse manager" as WH
participant "WEB market" as STOR
participant "Fleet management\n service" as FMS
participant "Authentication\n service" as AS
participant "Central control\n unit" as CCU
participant "Motion control\n unit" as MCU
participant "Positioning\n unit" as PU
participant "Odometer Positioning\nDriver" as OPD
participant "Sensors\n unit" as SU
participant "Locker\n unit" as LU
participant "Human-machine\n interface unit" as HMI
actor "User" as User

User    -> STOR:      new order

WH      -> STOR:     new delivery request
activate FMS
STOR    -> FMS
activate AS
FMS     -> AS:      create PIN
AS      -> User:    plain PIN
AS     --> FMS:     hashed PIN
deactivate AS
FMS     -> CCU:      new task (address+sig + hashed pin)

activate CCU

CCU    --> FMS:      delivery started

CCU     -> CCU:     decrypt PIN
CCU     -> CCU:     validate address signature
opt PIN decryption failed or adderess signature invalid
CCU    --> FMS:      unable to start task
end opt

loop go to user until destination reached

MCU     -> OPD:      odometry
OPD     -> PU:       position
PU      <-> CCU:     current position
CCU     -> MCU:      target driving\n speed & direction
MCU     -> MCU:       apply restrictions

end


CCU     -> MCU:     stop motors


loop
PU      -> SU:      current position
end

SU      -> CCU:     human detected
activate CCU #DDDDDD


loop until code valid or attempts count ended
User    -> HMI:     enter PIN
HMI     -> CCU:     access PIN
CCU     -> CCU:     check PIN
end

alt Valid PIN supplied

CCU     -> LU:      open locker
activate LU
LU      -> LU:      locker open\nfor 5sec
LU     --> CCU:     locker closed
LU     --> CCU:     locker door closed
deactivate LU

else Maximum invalid attempts count reached

CCU    --> FMS:      user failed to enter PIN

deactivate CCU
end

loop go to warehouse until destination reached
MCU     -> OPD:      odometry
OPD     -> PU:       position
PU      <-> CCU:     current position
CCU     -> MCU:      target driving\n speed & direction
end

CCU     -> MCU:     stop motors

CCU     --> FMS:     delivery ended

deactivate CCU

&FMS    --> WH:     delivery ended

deactivate FMS


@enduml