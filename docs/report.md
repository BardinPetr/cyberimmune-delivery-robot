# Отчёт о выполнении задачи "Робот-доставщик"

- [Отчёт о выполнении задачи "Робот-доставщик"](#отчёт-о-выполнении-задачи-робот-доставщик)
  - [Постановка задачи](#постановка-задачи)
  - [Известные ограничения и вводные](#известные-ограничения-и-вводные)
    - [Цели и Предположения Безопасности (ЦПБ)](#цели-и-предположения-безопасности-цпб)
      - [Цели](#цели)
      - [Предположения](#предположения)
  - [Архитектура решения](#архитектура-решения)
    - [Компоненты](#компоненты)
      - [Монитор безопасности](#монитор-безопасности-security-monitor)
    - [Алгоритм работы решения](#алгоритм-работы-решения)
    - [Описание сценариев), при которых ЦБ нарушаются](#описание-сценариев-при-которых-цб-нарушаются)
      - [Негативный сценарий 1. ](#негативный-сценарий-1-менеджер-не-проверяет-обновление)
      - [Сводная таблица негативных сценариев](#сводная-таблица-негативных-сценариев)
    - [Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора](#указание-доверенных-компонент-на-архитектурной-диаграмме-с-обоснованием-выбора)
    - [Политики безопасности](#политики-безопасности)
  - [Запуск приложения и тестов](#запуск-приложения-и-тестов)
    - [Запуск приложения](#запуск-приложения)
    - [Запуск тестов](#запуск-тестов)

---
## Постановка задачи

Задача заключается в построении безопасной системы управления парком автоматизированных роботов-доставщиков, 
для доставки заказов из интернет-магазина на дом клиенту с возможностью подтверждения личности клиента.

Реализовать прототип вышеописанного решения, в рамках которого
* "робот" получает задание на доставку с параметрами доставки (координаты, PIN)
* имитация сервиса доставки выдаёт информацию "приехал/не приехал" в консоль (механизм автоматического уведомления пользователя о прибытии робота не требуется)
* робот рассчитывает движение, осуществляет его с учётом ограничений и прибывает в место назначения
* также после состояния "приехал" через HMI пользователь может ввести PIN код для получения доступа к хранилищу
* если робот прибыл в место назначения и получил правильный PIN код, срабатывает имитация открытия хранилища (информация отображается в консольном окне)
* после "выдачи заказа" робот должен вернуться на склад и передать статус "доставлено" серверу
* в случае ошибки робот, не открывая хранилище, должен вернуться на склад и передать серверу статус "ошибка"

## Известные ограничения и вводные

1. По условиям организаторов должна использоваться микросервисная архитектура и шина обмена сообщениями для реализации асинхронной работы сервисов.
2. Разработка интернет магазина не требуется, процесс начинается с выдачи системе заказа менеджером склада
3. Разработка графических интерфейсов не требуется, вместо этого допустимо применение любых существующих решений для отправки REST запросов 
4. Для товаров принята модель без размера и веса, возможно заказать любой набор товаров
5. Робот должен иметь возможность функционировать автономно (без соединения с сетью) с момента получения роботом заказа и до возврата на склад
6. В рамках MVP не используются глобальные системы позиционирования, источник данных местоположения - одометрия

### Цели и Предположения Безопасности (ЦПБ)

#### Цели

1. обеспечение сохранности груза до момента передачи авторизованному клиенту
2. обеспечение достижения роботом исходно заданного местоположения
3. получение задания только от корпоративного сервера
4. невозможность доступа к грузу вне местоположения клиента
5. возврат груза на склад в случае многократных попыток неавторизованного доступа
6. все инциденты должны журналироваться

#### Предположения

1. не рассматриваются атаки, связанные с использованием физического доступа к роботу
2. в рамках задания не рассматривается процесс доставки PIN кода пользователю
3. робот должен иметь возможность функционировать автономно с момента получения задания до возврата на склад
4. задание считается выполненным по возвращении робота на склад
5. монитор безопасности считается доверенным
6. шина сообщений считается доверенной

## Архитектура решения

### Компоненты


| Название                         | Назначение                                                                                        | Комментарий                                                                                                      |
|----------------------------------|---------------------------------------------------------------------------------------------------|------------------------------------------------------------------------------------------------------------------|
| *Fleet management service* (FMS) | распределяет пользовательские заказы по роботам и обрабатывает статусы заказов                    | основной сервис в серверной части                                                                                |
| *Authentication service* (AS)    | обеспечивает создание, шифрование и распространение пользователям и FMS PIN-кодов                 | **новый сервис** *(см. описание негативных сценариев)* - обеспечивает сохранность PIN кода при компрометации FMS |
| *Communication service* (CS)     | осуществляет взаимодействие робота c сервисом управления парком роботов                           | REST взаимодействие с *FMS*                                                                                      |
| *Central control unit* (CCU)     | основная логика функционирования робота                                                           | взаимодействие со всеми сервисами робота через *MB*                                                              |
| *Positioning* (PU)               | определяет местоположение робота                                                                  | имитирует одометрию на основе данных *motion control*                                                            |
| *Motion control* (MCU)           | осуществляет управление механической частью робота                                                | основная задача - проверка ограничений на параметры движения                                                     |
| *Sensors* (SU)                   | получает информацию из внешней среды о препятствиях и управляет замком                            | всегда "видит" человека по прибытии на точку заказа                                                              |
| *HMI* (HMI)                      | осуществляет взаимодействие клиента с роботом                                                     | нет GUI/TUI, только REST запросы                                                                                 |
| *Security monitor* (SM)          | авторизует операцию, если она удовлетворяет заданным правилам или блокирует её в противном случае |                                                                                                                  |
| *Message bus* (MB)               | шина сообщений и брокер - сервис передачи сообщений от источника получателям                      | Kafka + Zookeeper                                                                                                |

_Сокращения данные в таблице далее будут активно использоваться_
  
![HLA]( "Архитектура")

#### Монитор безопасности

![SM]( "Монитор безопасности")

### Алгоритм работы решения

![Sequence diagram](./diagrams/res/sequence_base.png "Диаграмма вызовов")

### Описание сценариев, при которых ЦБ нарушаются

Рассмотрим возможные атаки на процесс доставки.

_Далее ЦБ - Цель Безопасности, ПБ - Предположение Безопасности._

![Негативные сценарии]("Негативные сценарии")

#### Негативный сценарий 1. (FMS выдает неверные задания)

Процесс начинается с получения FMS данных о заказе от менеджера склада. 
Данный модуль является единой точкой отказа для все системы, так как он обеспечивает диспетчеризацию заказов для всех роботов.
Отметим, что необходимо обеспечить физическую безопасность ЦОД, в котором размещен сервер с данным модулем.

При его компрометации возможно выдавать роботам задания не соответствующие пользовательским с заранее известными кодами доступа,  
что позволяет атакующему получить доступ к материальным ценностям доставляемым роботами, так как возможность проверки роботом содержания задания невозможна.

Нежелательно назначать FMS доверенным компонентом, так как данная система вероятнее всего сложна исходя из выполняемой бизнес-функции.
Значит FMS должен иметь возможность работы с заказом так (считаем что для диспетчеризации адрес точно нужен, иначе FMS не сможет в условиях реального города, как вариант расширения системы, выбрать склад наиболее близкий к пользователю), 
что внесенные в него изменения во время работы могли быть обнаружены до начала его выполнения.
Это реализуется посредствам добавления цифровой подписи в сообщение с адресом доставки на этапе до его отправки в FMS (в интернет магазине),
при этом криптографические ключи должны быть заранее установлены в робота. 
Тогда любая доверенная компонента в роботе может проверить, что доставка будет осуществлена в требуемое место.

Если злоумышленник имеет и адрес и код, он сможет изъять груз. Достаточно не дать доступа к одному из этих полей. 
Адрес мы должны обрабатывать в FMS, его шифровать нельзя, а вот PIN код нужен только на роботе, значит остается только зашифровать его перед передачей в FMS.
Введем в систему новый сервис - сервис аутентификации (AS), по изначальному заданию он тоже существует, но находится вне рассмотрения, так как реализует доставку PIN кода пользователю (ПБ №2).
Назначим ему создание PIN кода и отправку его пользователю. Тогда при передаче кода в FMS он будет его ассиметрично шифровать, а доверенный сервис на роботе - расшифровывать, аналогично с подписью адреса, заранее на роботе разместим криптографический ключ.
Также см. раздел указание доверенных компонент.

Вне рамок ПБ№2 (соответственно рассмотрено не будет) существует угроза перехвата PIN кода 
во время доставки его пользователю (MITM) или же посредством компрометации ПО пользовательского устройства. 
В таком случае возможно получить заказ вместо пользователя, причем защиты от этого на стороне робота не может быть 
кроме как через введение дополнительных вариантов авторизации (Bluetooth соединение со смартфоном, распознавание лиц)

![Негативный сценарий1]("FMS выдает неверные задания")


#### Сводная таблица негативных сценариев

### Указание "доверенных компонент" на архитектурной диаграмме с обоснованием выбора

![HLA-TCB]("Доверенные компоненты")

Придется назначить доверенным **Authentication Service**, так как иначе смысл шифрования PIN-кодов теряется, ибо будет легко извлечь исходные ключи, и использовать их как для расшифровки PIN, так и для создания подставных PIN.


![DFD-TCB]("Доверенные компоненты на диаграмме потоков данных")


### Политики безопасности


```python {lineNo:true}

```

## Запуск приложения и тестов

### Запуск приложения

см. [инструкцию по запуску](../readme.md)

### Запуск тестов
